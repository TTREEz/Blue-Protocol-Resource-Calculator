<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recipe Collector — Focus Calculator</title>
    <style>
        :root {
            --bg: #0f1220;
            --card: #161a2f;
            --muted: #8b90aa;
            --text: #e8eaf6;
            --accent: #7c9cff;
            --good: #35c759;
            --warn: #ffb020;
            --bad: #ff5d5d;
            --line: #2a2f55;
            --radius: 18px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #0e1020, #090b17);
            color: var(--text);
            font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial
        }

        header {
            position: sticky;
            top: 0;
            background: rgba(9, 11, 23, .8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--line);
            z-index: 10
        }

        header .wrap {
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 1200px;
            margin: auto;
            padding: 14px 20px
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 18px
        }

        @media (max-width:980px) {
            main {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25)
        }

        .card h2 {
            font-size: 18px;
            margin: 0 0 12px;
            color: #fff
        }

        .card .inner {
            padding: 18px
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .row3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        label {
            font-weight: 600
        }

        small {
            color: var(--muted)
        }

        input,
        select,
        textarea,
        button {
            font: inherit
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            background: #0f1330;
            border: 1px solid var(--line);
            border-radius: 12px;
            color: var(--text);
            padding: 10px 12px;
            outline: none
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            appearance: none;
            margin: 0
        }

        textarea {
            min-height: 68px;
            resize: vertical
        }

        .muted {
            color: var(--muted)
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #0c102a;
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 6px 10px
        }

        .btn {
            border: 1px solid var(--line);
            background: #0f1330;
            color: #fff;
            border-radius: 12px;
            padding: 10px 12px;
            cursor: pointer
        }

        .btn.primary {
            background: var(--accent);
            border-color: #5e7fff;
            color: #0b0e1f;
            font-weight: 700
        }

        .btn.ghost {
            background: transparent
        }

        .btn.inline {
            padding: 6px 10px;
            border-radius: 999px
        }

        .btn.small {
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 14px
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }

        hr {
            border: 0;
            border-top: 1px solid var(--line);
            margin: 14px 0
        }

        /* Ingredients */
        .ingredients {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .ing-row {
            display: grid;
            grid-template-columns: 1fr 120px 40px;
            gap: 8px
        }

        .ing-row input {
            width: 100%
        }

        .ing-row .del {
            display: flex;
            align-items: center;
            justify-content: center
        }

        /* Yield tally */
        .tally {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 12px;
            background: #10153b;
            border: 1px solid var(--line)
        }

        .chip strong {
            min-width: 28px;
            text-align: center
        }

        .chip .cnt {
            background: #0d1233;
            border: 1px solid var(--line);
            padding: 2px 8px;
            border-radius: 999px
        }

        .chip .inc,
        .chip .dec {
            border: 1px solid var(--line);
            background: #0b0f2b;
            color: #fff;
            border-radius: 8px;
            padding: 4px 8px;
            cursor: pointer
        }

        /* Preview */
        pre {
            margin: 0;
            background: #0b0f29;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 520px;
            overflow: auto
        }

        .grid-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .badge {
            display: inline-block;
            background: #0b1133;
            border: 1px solid var(--line);
            padding: 6px 10px;
            border-radius: 999px;
            color: #c9d1ff
        }

        .right-col .card {
            position: sticky;
            top: 76px
        }

        .ok {
            color: var(--good)
        }

        .warn {
            color: var(--warn)
        }

        .err {
            color: var(--bad)
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }
    </style>
</head>

<body>
    <header>
        <div class="wrap">
            <h1>Recipe Collector</h1>
            <span class="badge" id="confidence">Confidence: —</span>
            <span class="badge">Autosave On</span>
        </div>
    </header>

    <main>
        <section class="left-col">
            <div class="card">
                <div class="inner">
                    <div class="section-title">
                        <h2>1) Basics</h2>
                        <div class="toolbar">
                            <button class="btn small ghost" id="resetForm">Reset</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Recipe name</label>
                            <input id="recipeName" type="text" placeholder="e.g., Smelt Iron" />
                        </div>
                        <div class="field">
                            <label>Output item (optional)</label>
                            <input id="outputItem" type="text" placeholder="e.g., Iron Ingot" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Activity</label>
                            <select id="activity">
                                <option>Craft</option>
                                <option>Gather</option>
                                <option>Mine</option>
                            </select>
                            <small class="muted">Choose how this is performed.</small>
                        </div>
                        <div class="field">
                            <label>Is mineable?</label>
                            <select id="isMineable">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                            <small class="muted">If yes, Ingredients may be unnecessary.</small>
                        </div>
                    </div>

                    <hr />
                    <h2>2) Ingredients</h2>
                    <div class="ingredients" id="ingredients"></div>
                    <div class="grid-actions" style="margin-top:8px">
                        <button class="btn small" id="addIng">Add ingredient</button>
                        <button class="btn small ghost" id="clearIng">Clear all</button>
                    </div>

                    <hr />
                    <h2>3) Focus & Time</h2>
                    <div class="row">
                        <div class="field">
                            <label>Focus cost per craft (optional)</label>
                            <input id="focusCost" type="number" step="0.01" placeholder="e.g., 12" />
                        </div>
                        <div class="field">
                            <label>Time capture mode</label>
                            <select id="timeMode">
                                <option value="per">Per-action seconds</option>
                                <option value="bulk">I did N actions in T seconds</option>
                            </select>
                        </div>
                    </div>
                    <div id="timePer" class="row">
                        <div class="field">
                            <label>Seconds per action</label>
                            <input id="timePerSec" type="number" step="0.01" placeholder="e.g., 18.5" />
                        </div>
                        <div class="field">
                            <label>Stopwatch</label>
                            <div class="grid-actions">
                                <button class="btn small" id="swStart">Start</button>
                                <button class="btn small" id="swLap">Lap (+1 action)</button>
                                <button class="btn small ghost" id="swStop">Stop</button>
                                <span id="swReadout" class="pill">00:00.0 | actions: 0</span>
                            </div>
                            <small class="muted">Use lap for each craft/action; we compute average
                                seconds/action.</small>
                        </div>
                    </div>
                    <div id="timeBulk" class="row" style="display:none">
                        <div class="field">
                            <label>Actions completed</label>
                            <input id="bulkN" type="number" step="1" placeholder="e.g., 20" />
                        </div>
                        <div class="field">
                            <label>Total seconds</label>
                            <input id="bulkT" type="number" step="0.01" placeholder="e.g., 370" />
                        </div>
                    </div>

                    <hr />
                    <h2>4) Yield</h2>
                    <div class="row">
                        <div class="field">
                            <label>Yield type</label>
                            <select id="yieldType">
                                <option value="fixed">Fixed</option>
                                <option value="variable">Variable</option>
                            </select>
                        </div>
                        <div class="field" id="fixedYieldWrap">
                            <label>Fixed yield (items per craft)</label>
                            <input id="fixedYield" type="number" step="0.01" placeholder="e.g., 1" />
                        </div>
                    </div>

                    <div id="varYieldWrap" style="display:none">
                        <div class="tally">
                            <div class="row3">
                                <div class="field">
                                    <label>Quick add outcome</label>
                                    <div class="grid-actions">
                                        <input id="quickOutcome" type="number" step="1" placeholder="e.g., 10" />
                                        <button class="btn small" id="addOutcome">Add chip</button>
                                    </div>
                                    <small class="muted">Add each distinct yield you see (e.g., 10, 11, 12) then tap +
                                        when it occurs.</small>
                                </div>
                                <div class="field">
                                    <label>Min (auto)</label>
                                    <input id="yieldMin" type="number" step="1" placeholder="—" disabled />
                                </div>
                                <div class="field">
                                    <label>Max (auto)</label>
                                    <input id="yieldMax" type="number" step="1" placeholder="—" disabled />
                                </div>
                            </div>
                            <div class="chips" id="chips"></div>
                            <div class="grid-actions">
                                <span class="pill">Sample size: <strong id="sampleSize">0</strong></span>
                                <span class="pill">Observed avg: <strong id="obsAvg">—</strong></span>
                                <button class="btn small ghost" id="resetTally">Reset tally</button>
                            </div>
                        </div>
                    </div>

                    <hr />
                    <h2>5) Profile (optional)</h2>
                    <div class="row">
                        <div class="field">
                            <label>Profile</label>
                            <div class="grid-actions">
                                <select id="profileSelect"></select>
                                <button class="btn small" id="saveProfile">Save</button>
                                <button class="btn small ghost" id="deleteProfile">Delete</button>
                            </div>
                            <small class="muted">Create a character profile once, then reuse for multiple
                                submissions.</small>
                        </div>
                        <div class="field">
                            <label>Nickname (optional)</label>
                            <input id="nickname" type="text" placeholder="Helps trust weighting" />
                        </div>
                    </div>
                    <div class="row3">
                        <div class="field">
                            <label>Character name</label>
                            <input id="charName" type="text" />
                        </div>
                        <div class="field">
                            <label>Level</label>
                            <input id="charLevel" type="number" step="1" />
                        </div>
                        <div class="field">
                            <label>Tool tier</label>
                            <input id="toolTier" type="text" placeholder="e.g., T1, T2" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Buffs (comma-separated)</label>
                            <input id="buffs" type="text" placeholder="e.g., Workshop I, Food Buff" />
                        </div>
                        <div class="field">
                            <label>Region/Station</label>
                            <input id="region" type="text" placeholder="e.g., Capital City / Blacksmith Bench" />
                        </div>
                    </div>

                    <hr />
                    <div class="row">
                        <div class="field">
                            <label>Notes (optional)</label>
                            <textarea id="notes" placeholder="Anything helpful or weird you noticed."></textarea>
                        </div>
                        <div class="field">
                            <label>Observed date</label>
                            <input id="observedAt" type="date" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:14px">
                <div class="inner">
                    <div class="section-title">
                        <h2>Submit</h2>
                        <div class="toolbar">
                            <button class="btn small" id="copyJson">Copy JSON</button>
                            <button class="btn small" id="downloadJson">Download .json</button>
                        </div>
                    </div>
                    <small class="muted">This creates a single Observation JSON you can send or paste. It includes the
                        yield tally so you never have to compute averages.</small>
                </div>
            </div>
        </section>

        <aside class="right-col">
            <div class="card">
                <div class="inner">
                    <div class="section-title">
                        <h2>JSON preview</h2>
                        <div class="toolbar">
                            <span class="pill" id="keyPreview">recipe_key: —</span>
                        </div>
                    </div>
                    <pre id="jsonPreview">{}</pre>
                </div>
            </div>
        </aside>
    </main>

    <script>
        (function () {
            // ---------- utilities ----------
            const $ = sel => document.querySelector(sel);
            const $$ = sel => Array.from(document.querySelectorAll(sel));
            const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
            const slug = s => (s || '').toString().trim().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            const todayISO = () => new Date().toISOString().slice(0, 10);

            // ---------- persistent state ----------
            const store = {
                read(k, fallback) { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); } catch (e) { return fallback; } },
                write(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
            };

            const state = {
                ingredients: [],
                tally: {}, // {value: count}
                laps: [],   // stopwatch laps (seconds)
                profiles: store.read('bp_profiles', { list: [], last: null }),
            };

            // ---------- elements ----------
            const recipeName = $('#recipeName');
            const outputItem = $('#outputItem');
            const activity = $('#activity');
            const isMineable = $('#isMineable');
            const ingWrap = $('#ingredients');
            const addIng = $('#addIng');
            const clearIng = $('#clearIng');
            const focusCost = $('#focusCost');
            const timeMode = $('#timeMode');
            const timePer = $('#timePer');
            const timeBulk = $('#timeBulk');
            const timePerSec = $('#timePerSec');
            const bulkN = $('#bulkN');
            const bulkT = $('#bulkT');
            const swStart = $('#swStart');
            const swLap = $('#swLap');
            const swStop = $('#swStop');
            const swReadout = $('#swReadout');
            const yieldType = $('#yieldType');
            const fixedYieldWrap = $('#fixedYieldWrap');
            const fixedYield = $('#fixedYield');
            const varYieldWrap = $('#varYieldWrap');
            const quickOutcome = $('#quickOutcome');
            const addOutcome = $('#addOutcome');
            const chips = $('#chips');
            const sampleSize = $('#sampleSize');
            const obsAvg = $('#obsAvg');
            const yieldMin = $('#yieldMin');
            const yieldMax = $('#yieldMax');
            const resetTally = $('#resetTally');
            const profileSelect = $('#profileSelect');
            const saveProfile = $('#saveProfile');
            const deleteProfile = $('#deleteProfile');
            const charName = $('#charName');
            const charLevel = $('#charLevel');
            const toolTier = $('#toolTier');
            const buffs = $('#buffs');
            const region = $('#region');
            const nickname = $('#nickname');
            const notes = $('#notes');
            const observedAt = $('#observedAt');
            const keyPreview = $('#keyPreview');
            const jsonPreview = $('#jsonPreview');
            const copyJson = $('#copyJson');
            const downloadJson = $('#downloadJson');
            const resetForm = $('#resetForm');
            const confidence = $('#confidence');

            observedAt.value = todayISO();

            // ---------- ingredients UI ----------
            function addIngredientRow(data = { name: '', qty: '' }) {
                const row = document.createElement('div');
                row.className = 'ing-row';
                row.innerHTML = `
      <input type="text" placeholder="Item name" value="${(data.name || '').replace(/"/g, '&quot;')}">
      <input type="number" step="0.01" placeholder="Qty" value="${data.qty ?? ''}">
      <div class="del"><button class="btn small ghost">✕</button></div>`;
                const [nameEl, qtyEl] = row.querySelectorAll('input');
                row.querySelector('button').addEventListener('click', () => { row.remove(); syncIngredients(); });
                nameEl.addEventListener('input', syncIngredients);
                qtyEl.addEventListener('input', syncIngredients);
                ingWrap.appendChild(row);
                syncIngredients();
            }
            function syncIngredients() {
                const rows = $$('.ing-row');
                state.ingredients = rows.map(r => {
                    const [nEl, qEl] = r.querySelectorAll('input');
                    const name = nEl.value.trim();
                    const qty = Number(qEl.value);
                    return name && !isNaN(qty) && qty > 0 ? { name, qty } : null;
                }).filter(Boolean);
                render();
            }
            addIng.addEventListener('click', () => addIngredientRow());
            clearIng.addEventListener('click', () => { ingWrap.innerHTML = ''; state.ingredients = []; render(); });
            // pre-add one row
            addIngredientRow();

            // ---------- yield tally ----------
            function renderChips() {
                chips.innerHTML = '';
                const keys = Object.keys(state.tally).map(Number).sort((a, b) => a - b);
                keys.forEach(val => {
                    const count = state.tally[val] || 0;
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.innerHTML = `<strong>${val}</strong><span class="cnt">x ${count}</span>`;
                    const inc = document.createElement('button'); inc.className = 'inc'; inc.textContent = '+';
                    const dec = document.createElement('button'); dec.className = 'dec'; dec.textContent = '−';
                    inc.addEventListener('click', () => {
                        state.tally[val] = (state.tally[val] || 0) + 1;
                        renderChips();               // <- re-render so the visible "xN" changes immediately
                    });
                    dec.addEventListener('click', () => {
                        state.tally[val] = Math.max(0, (state.tally[val] || 0) - 1);
                        if (state.tally[val] === 0) delete state.tally[val];
                        renderChips();               // <- same here
                    });

                    chip.appendChild(inc); chip.appendChild(dec);
                    chips.appendChild(chip);
                });
                updateTallyDerived();
            }
            function updateTallyDerived() {
                const entries = Object.entries(state.tally).map(([k, v]) => [Number(k), Number(v) || 0]).filter(([, c]) => c > 0);
                const n = entries.reduce((s, [, c]) => s + c, 0);
                sampleSize.textContent = n;
                if (entries.length) {
                    const total = entries.reduce((s, [val, c]) => s + val * c, 0);
                    const avg = total / (n || 1);
                    obsAvg.textContent = avg.toFixed(3);
                    const mins = Math.min(...entries.map(([v]) => v));
                    const maxs = Math.max(...entries.map(([v]) => v));
                    yieldMin.value = mins;
                    yieldMax.value = maxs;
                } else {
                    obsAvg.textContent = '—';
                    yieldMin.value = '';
                    yieldMax.value = '';
                }
                render();
            }

            addOutcome.addEventListener('click', () => {
                const v = Number(quickOutcome.value);
                if (Number.isFinite(v)) {
                    state.tally[v] = (state.tally[v] || 0) + 1;   // <- start at 1 or increment
                    renderChips();                                // <- rebuild chips so xN updates
                }
                quickOutcome.value = '';
                quickOutcome.focus();
            });

            quickOutcome.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); addOutcome.click(); }
            });

            resetTally.addEventListener('click', () => { state.tally = {}; renderChips(); });

            // ---------- time capture ----------
            timeMode.addEventListener('change', () => {
                const mode = timeMode.value;
                timePer.style.display = mode === 'per' ? '' : 'none';
                timeBulk.style.display = mode === 'bulk' ? '' : 'none';
                render();
            });

            let swTimer = null, swStartTime = 0;
            function fmtMs(ms) { const s = ms / 1000; const m = Math.floor(s / 60); const r = s - m * 60; return `${String(m).padStart(2, '0')}:${r.toFixed(1).padStart(4, '0')}`; }
            function refreshStopwatch() {
                const elapsed = (swTimer ? Date.now() - swStartTime : 0);
                const avg = state.laps.length ? (state.laps.reduce((a, b) => a + b, 0) / state.laps.length) : 0;
                const read = `${fmtMs(elapsed)} | actions: ${state.laps.length}${avg ? ` | avg: ${avg.toFixed(2)}s` : ''}`;
                swReadout.textContent = read;
            }
            setInterval(refreshStopwatch, 100);
            swStart.addEventListener('click', () => { if (!swTimer) { swStartTime = Date.now(); swTimer = true; } });
            swLap.addEventListener('click', () => {
                if (swTimer) {
                    const now = Date.now();
                    const lap = (now - swStartTime) / 1000;
                    state.laps.push(lap);
                    swStartTime = now;
                    timePerSec.value = (state.laps.reduce((a, b) => a + b, 0) / state.laps.length).toFixed(3);
                    render();
                }
            });
            swStop.addEventListener('click', () => { swTimer = null; refreshStopwatch(); });

            // ---------- profiles ----------
            function loadProfiles() {
                const { list, last } = state.profiles;
                profileSelect.innerHTML = '';
                const optNew = document.createElement('option'); optNew.value = '__new__'; optNew.textContent = '— New Profile —'; profileSelect.appendChild(optNew);
                list.forEach(p => {
                    const o = document.createElement('option'); o.value = p.id; o.textContent = p.label; profileSelect.appendChild(o);
                });
                if (last && list.find(p => p.id === last)) profileSelect.value = last; else profileSelect.value = '__new__';
                applySelectedProfile();
            }
            function applySelectedProfile() {
                const id = profileSelect.value;
                if (id === '__new__') { return; }
                const p = state.profiles.list.find(x => x.id === id);
                if (!p) return;
                charName.value = p.charName || '';
                charLevel.value = p.charLevel || '';
                toolTier.value = p.toolTier || '';
                buffs.value = (p.buffs || []).join(', ');
                region.value = p.region || '';
                nickname.value = p.nickname || '';
                state.profiles.last = id; persistProfiles();
                render();
            }
            function persistProfiles() { store.write('bp_profiles', state.profiles); }
            profileSelect.addEventListener('change', applySelectedProfile);
            saveProfile.addEventListener('click', () => {
                const id = profileSelect.value === '__new__' ? `p_${Date.now()}` : profileSelect.value;
                const label = charName.value || nickname.value || `Profile ${new Date().toLocaleDateString()}`;
                const profile = { id, label, charName: charName.value, charLevel: Number(charLevel.value) || null, toolTier: toolTier.value, buffs: (buffs.value || '').split(',').map(s => s.trim()).filter(Boolean), region: region.value, nickname: nickname.value };
                const idx = state.profiles.list.findIndex(p => p.id === id);
                if (idx >= 0) state.profiles.list[idx] = profile; else state.profiles.list.push(profile);
                state.profiles.last = id; persistProfiles(); loadProfiles();
            });
            deleteProfile.addEventListener('click', () => {
                const id = profileSelect.value; if (id === '__new__') return;
                state.profiles.list = state.profiles.list.filter(p => p.id !== id);
                state.profiles.last = null; persistProfiles(); loadProfiles();
            });
            loadProfiles();

            // ---------- computed fields ----------
            function computePerActionSeconds() {
                if (timeMode.value === 'per') {
                    const v = Number(timePerSec.value);
                    return Number.isFinite(v) && v > 0 ? v : null;
                } else {
                    const n = Number(bulkN.value), t = Number(bulkT.value);
                    if (Number.isFinite(n) && n > 0 && Number.isFinite(t) && t > 0) { return t / n; }
                    return null;
                }
            }
            function recipeKey(obs) {
                const ing = (obs.ingredients || []).slice().sort((a, b) => a.name.localeCompare(b.name)).map(i => `${i.name.toLowerCase()}:${i.qty}`).join('|');
                return `${slug(obs.recipe_name)}|${ing}`;
            }
            function confidenceScore(obs) {
                const n = obs.sample_size || 0;
                const iqrPenalty = 0; // client-side we don't know yet
                const base = Math.log10(1 + n * 5); // mild boost per sample
                return Math.max(0, Math.min(1, (base - iqrPenalty) / 2));
            }

            // ---------- build observation ----------
            function buildObservation() {
                // yield object
                const yType = yieldType.value;
                let y = {};
                if (yType === 'fixed') {
                    const fy = Number(fixedYield.value);
                    y = { fixed: Number.isFinite(fy) ? fy : null, min: null, max: null, observed_avg: null, outcomes: null };
                } else {
                    const entries = Object.entries(state.tally).map(([k, v]) => [Number(k), Number(v) || 0]).filter(([, c]) => c > 0).sort((a, b) => a[0] - b[0]);
                    const n = entries.reduce((s, [, c]) => s + c, 0);
                    const total = entries.reduce((s, [val, c]) => s + val * c, 0);
                    const avg = n ? total / n : null;
                    const min = entries.length ? entries[0][0] : null;
                    const max = entries.length ? entries[entries.length - 1][0] : null;
                    y = { fixed: null, min, max, observed_avg: avg, outcomes: Object.fromEntries(entries) };
                }

                const player = {
                    name: charName.value || null,
                    level: Number(charLevel.value) || null,
                    tool_tier: toolTier.value || null,
                    buffs: (buffs.value || '').split(',').map(s => s.trim()).filter(Boolean),
                    region_or_station: region.value || null,
                    nickname: nickname.value || null,
                    profile_id: profileSelect.value === '__new__' ? null : profileSelect.value
                };

                const obs = {
                    schema_version: 2,
                    recipe_key: '', // fill after compute
                    recipe_name: recipeName.value.trim(),
                    activity: activity.value,
                    isMineable: isMineable.value === 'yes',
                    output_item: (outputItem.value || '').trim() || recipeName.value.trim(),
                    ingredients: state.ingredients.slice(),
                    focus_cost_per_craft: numOrNull(focusCost.value),
                    time_per_craft_seconds: computePerActionSeconds(),
                    time_measurement: timeMode.value === 'per'
                        ? { mode: 'per_action', per_action_seconds: numOrNull(timePerSec.value), laps: state.laps.map(x => Number(x.toFixed(3))) }
                        : { mode: 'bulk', bulk_actions: numOrNull(bulkN.value), bulk_total_seconds: numOrNull(bulkT.value) },
                    yield: y,
                    sample_size: yType === 'variable' ? (Object.values(state.tally).reduce((a, b) => a + Number(b || 0), 0)) : (y.fixed != null ? 1 : 0),
                    notes: (notes.value || '').trim() || null,
                    observed_at: observedAt.value || todayISO()
                };
                obs.recipe_key = recipeKey(obs);
                return obs;
            }
            function numOrNull(x) { const n = Number(x); return Number.isFinite(n) ? n : null; }

            // ---------- preview & actions ----------
            function render() {
                // show/hide ingredients when mineable true
                const hideIngs = isMineable.value === 'yes';
                ingWrap.style.display = hideIngs ? 'none' : '';
                const ingControls = addIng ? addIng.closest('.grid-actions') : null;
                if (ingControls) ingControls.style.display = hideIngs ? 'none' : '';


                const mode = yieldType.value;
                fixedYieldWrap.style.display = mode === 'fixed' ? '' : 'none';
                varYieldWrap.style.display = mode === 'variable' ? '' : 'none';

                const obs = buildObservation();
                const key = obs.recipe_key || '—';
                keyPreview.textContent = 'recipe_key: ' + key;

                // confidence
                const c = confidenceScore(obs);
                const pct = Math.round(c * 100);
                confidence.textContent = 'Confidence: ' + (obs.sample_size ? pct + '%' : '—');

                jsonPreview.textContent = JSON.stringify(obs, null, 2);
            }

            // inputs that trigger render
            [recipeName, outputItem, activity, isMineable, focusCost, timeMode, timePerSec, bulkN, bulkT, yieldType,
                fixedYield, quickOutcome, nickname, notes, observedAt, charName, charLevel, toolTier, buffs, region]
                .forEach(el => el.addEventListener('input', render));

            // initial chips
            renderChips();

            copyJson.addEventListener('click', async () => {
                const txt = jsonPreview.textContent;
                try { await navigator.clipboard.writeText(txt); toast('JSON copied'); } catch (e) { alert('Copy failed.'); }
            });
            downloadJson.addEventListener('click', () => {
                const blob = new Blob([jsonPreview.textContent], { type: 'application/json' });
                const a = document.createElement('a');
                const name = slug($('#recipeName').value || 'recipe') + '-' + Date.now() + '.json';
                a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
            });

            resetForm.addEventListener('click', () => {
                if (!confirm('Clear all fields?')) return;
                $$('input').forEach(i => { if (i.type === 'date') return; if (i.type === 'number' || i.type === 'text') i.value = ''; });
                $$('textarea').forEach(t => t.value = '');
                activity.value = 'Craft'; isMineable.value = 'no';
                timeMode.value = 'per'; timePerSec.value = ''; bulkN.value = ''; bulkT.value = '';
                state.laps = []; swTimer = null; refreshStopwatch();
                yieldType.value = 'fixed'; state.tally = {}; renderChips();
                ingWrap.innerHTML = ''; state.ingredients = []; addIngredientRow();
                observedAt.value = todayISO();
                render();
            });

            function toast(msg) {
                const t = document.createElement('div');
                t.textContent = msg; t.style.position = 'fixed'; t.style.bottom = '20px'; t.style.right = '20px'; t.style.background = '#11163b'; t.style.border = '1px solid var(--line)'; t.style.padding = '10px 12px'; t.style.borderRadius = '10px'; t.style.boxShadow = '0 6px 20px rgba(0,0,0,.35)';
                document.body.appendChild(t); setTimeout(() => t.remove(), 1400);
            }

            // initial render
            render();
        })();
    </script>
</body>

</html>